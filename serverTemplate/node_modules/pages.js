var user = require("db/user")

exports.pageWrapper = pageWrapper
function pageWrapper(contents) {
    return htmlWrapper(contents, '\
        <link type="text/css" rel=stylesheet  href="/static/style/main.less"> \
                                                                  \
        <title>perFund - An inbox for your money</title>          \
                                                                  \
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.0/jquery.min.js"></script> \
        <script type="text/javascript" src="/static/js/util/ExceptionHandler.jquery.js"></script>                               \
        <script type="text/javascript" src="/static/js/util/inputSelection.jquery.js"></script>                               \
        <!--<script type="text/javascript" src="/static/js/util/crashkit.js"></script>                                     ---> \
        <script type="text/javascript" src="/static/js/util/cept.js"></script>                               \
        <script type="text/javascript" src="/static/js/util/nestedSelectors.jquery.js"></script>                               \
        <script type="text/javascript" src="/static/js/javascript.js"></script>                                                \
        <script type="text/javascript" src="/static/js/cookies.min.js"></script>                                                \
    ')
}

exports.htmlWrapper = htmlWrapper
function htmlWrapper(contents, headers) {
    if(!headers) headers = ''

    return '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">      \
            <html xmlns="http://www.w3.org/1999/xhtml">                                                     \
            <head>                                                                                          \
                <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />                       \
                <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;"/> \
                                                                                                            \
                <META HTTP-EQUIV="Pragma" CONTENT="no-cache">                                               \
                <META HTTP-EQUIV="Expires" CONTENT="-1">                                                    \
                '+headers+'                                                                                 \
            </head>                                                                                         \
                                                                                                            \
            <!--[if lt IE 7]>  <body class="ie ie6 lte9 lte8 lte7 lte6"> <![endif]-->                       \
            <!--[if IE 7]>     <body class="ie ie7 lte9 lte8 lte7"> <![endif]-->                            \
            <!--[if IE 8]>     <body class="ie ie8 lte9 lte8"> <![endif]-->                                 \
            <!--[if IE 9]>     <body class="ie ie9 lte9"> <![endif]-->                                      \
            <!--[if IE 10]>    <body class="ie ie10 lte10"> <![endif]-->                                     \
            <!--[if gt IE 10]> <body class="ie gt10"> <![endif]-->                                           \
            <!--[if !IE]><!--> <body>             <!--<![endif]-->                                          \
                '+contents+'                                                                                 \
            </body>'
}

exports.login = login
function login() {
    var $signUpEnabled = true // config.signUpEnabled

    if($signUpEnabled) {
        var $signUpHtml = '\
            <div id="signUp">                                                      \
                <div class="sideTab signUpTab">Sign Up</div>                       \
                <div class=mainTab>                                                \
                    <div id=password2>                                             \
                        <div class=label>Retype Password:</div>                    \
                        <input class="loginInput" type="password" id="password2">  \
                        <div class=error></div>                                    \
                    </div>                                                         \
                    <div class="button">Sign Up</div>                              \
                </div>                                                             \
            </div>                                                                 \
            '

        var signUpHandler = function() {
            Util.ajax("/signUp",
                {username: $("#username .loginInput").val(), password: $("#password1 .loginInput").val(),password2: $("#password2 .loginInput").val()},
                    function(data) {
                    if(data.result == "success") {
                        View.showMainPage()

                    } else if(data.result == "userExistsButPasswordsMatch") {
                        alert("Looks like you already have an account!")

                        View.showMainPage()

                    } else if(data.result == "userExists") {
                        $("#username .error").html("Sorry, that user already exists!")

                    } else if(data.result == "invalidName") {
                        $("#password1 .error").html("Username isn't valid, please try another username")

                    } else {
                        throw new cept("Invalid result from /signUp: "+JSON.stringify(data))
                    }
                })
        }
    } else {
        var signUpHandler = ''
    }

    var $page = '\
            <div id=loginOrSignUp>                                                                               \
                <div id=login>                                                                                   \
                    <div class="sideTab loginTab"><span>Login</span></div>                                       \
                    <div class=mainTab>                                                                          \
                        <div id=username>                                                                        \
                            <div class=label>Username:</div>                                                     \
                            <input class="loginInput" type="text">                                               \
                            <div class=error></div>                                                              \
                        </div>                                                                                   \
                        <div id=password1>                                                                       \
                            <div class=label>Password:</div>                                                     \
                            <input class="loginInput" type="password">                                           \
                            <div class=error></div>                                                              \
                        </div>                                                                                   \
                        <div class="button">Login</div>                                                          \
                    </div>                                                                                       \
                </div>                                                                                           \
                '+$signUpHtml+'                                                                                  \
            </div>                                                                                               \
            <script type="text/javascript">                                                                      \n\
            var loginHandler = '+loginHandler.toString()+'                                                      \n\
            var signUpHandler = '+signUpHandler.toString()+'                                                    \n\
            ;('+init.toString()+')()                                                                      \n\
            </script>'


    function loginHandler() {
        Util.ajax("/login",
            {username: $("#username .loginInput").val(), password: $("#password1 .loginInput").val()},
            function(data) {
                if(data.result == "success") {
                    var options = {expires: 60*60*24*30}    // todo: make this the same as the expiration of the token (programatically the same)
                    Cookies("token", data.token, options)
                    View.showMainPage()

                } else if(data.result == "passwordMismatch") {
                    $("#password1 .error").html("Username and password don't match")

                } else if(data.result == "noUser") {
                    $("#username .error").html("That user doesn't exist")

                } else {
                    Util.invalidResult("/login", data)
                }

        })
    }

    function init() {
        function keyEnter(callback) {
            return function(event) {
                if(event.which == "\n".charCodeAt(0) || event.which == "\r".charCodeAt(0))
                    return callback()
            }
        }

        $("#login .button").click(loginHandler)
        $("#username input").keypress(keyEnter(function() {
            var pass = $("#password1 input")
            pass.selectRange(0,pass.val().length)
        }))
        $("#password1 input").keypress(keyEnter(loginHandler))

        $("#signUp .button").click(signUpHandler)
        $("#password2").keypress(keyEnter(signUpHandler))
    }

    return $page
}

exports.logout = function() {
		return '\
            <div id=accountControls>                                \
            	<!--<div class="account button">Account</div>-->    \
            	<div class="logout button">Logout</div>             \
			</div>                                                  \
			<script type="text/javascript">                         \n\
			;('+hookupAccountControls.toString()+')() \n\
			</script>'

        function hookupAccountControls() {
            $("#accountControls .logout").click(function() {
                Util.ajax('/logout', {}, function() {
                    window.location = "/"
                })
            })
        }
}

exports.profile = function(id) {
    var curUser = user.get(id)
    return '                                                            \
        <div id=profile>                                                \
            <div class=image><img src="/userfile/image/SPY.JPG"></div>  \
            <div class=id>'+curUser._id+'</div>                                  \
            <div class=name>Huw Aur Eugh</div>                          \
            <div class=username>'+curUser.sn+'</div>              \
            <div class=email>some@email.com</div>                       \
        </div>'
}

exports.transactions = function() {
    return '                                                               \
        <div id=transactions>                                              \
            <div class="create button">+Create</div>                       \
            <div class="createForm hide">                                  \
                <input type=text class=otherParty	title="Other Party">   \
                <select class=direction>                                   \
                    <option value="positive">owes me</option>              \
                    <option value="negative">is owed</option>              \
                </select>                                                  \
                <input type=text class=amount		title="23">            \
                <input type=text class=subject		title="Subject">       \
                <div class="send button">Send</div>                        \
            </div>                                                         \
            <table><tbody>                                                 \
                <tr class="header">                                        \
                    <th>Accepted?</th>                                     \
                    <th>Other<br>Party</th>                                \
                    <th>Amount</th>                                        \
                    <th>Running<br>balance</th>                            \
                    <!--<th>Personal<br>Running<br>Balance</th>-->         \
                    <th>Subject/Message<br>Preview</th>                    \
                    <th>Date</th>                                          \
                </tr>                                                      \
            </tbody></table>                                               \
        </div>                                                             \
        <script type="text/javascript">                                    \n\
        ;('+hookupTransactions.toString()+')()        \n\
        </script>'

    function hookupTransactions() {
        Actions.refreshTransactions()

        $('#transactions').nest(function(get) {
            get('.createForm input').each(function() {
                $(this).val($(this).attr('title'))
            })

            get('.create').click(function() {
                get('.createForm').show()
            })

            get('.send').click(function() {
                get('.createForm').hide()

                var amount = get('.amount').val()
                if(get('.direction').val() == 'negative') amount = -1*parseFloat(amount)

                Util.ajax('/createTransaction', {
                    token: Cookies("token"),
                    otherPartyName: get('.otherParty').val(),
                    amount: amount,
                    subject:  get('.subject').val()
                },
                function(data) {
                    if(data.result == 'success') {
                        Actions.refreshTransactions()
                    } else {
                        Util.invalidResult('/login', data)
                    }
                })
            })

        })
    }
}
